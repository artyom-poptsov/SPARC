\documentclass[../sparc.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Память}
\label{section:avr-memory}
\index{Аппаратное обеспечение!Память}

На данном этапе нам необходимо научиться ориентироваться в закоулках памяти
микроконтроллера, подготовить карту с адресами полезных мест -- это потребуется
для дальнейшего изучения работы с прерываниями.

Поэтому в данном разделе мы будем исследовать устройство памяти
микроконтроллеров семейства AVR (которые лежат в основе большинства плат
Arduino.)

%% Итак, мы теперь знаем, что есть \gls{OCR}-ячейки, с которыми сравнивается
%% значение таймера.  Но что же представляют собой данные ячейки?

%% \index{Архитектура процессора!Память!Регистры}
%% Как было сказано в предыдущем разделе, ``OCR'' расшифровывается, как ``Output
%% Compare Register'', или ``Выходной Регистр Сравнения''.  \emph{Регистрами}
%% называются ячейки самой быстрой памяти, которая находится внутри процессора.
%% Количество и объём данных ячеек сильно ограничены и зависит от устройства
%% (архитектуры) процессора.

\subsection{Типы памяти}
\index{Архитектура процессора!Память!Виды памяти}

Память является одним из основных ресурсов компьютера.  Различают два основных
типа памяти:
\begin{itemize}
\item \emph{Энерго-зависимая} память хранит данные только тогда, когда компьютер
  работает.  Как только питание на память перестаёт поступать, её ячейки
  очищаются.  Таким образом можно сказать, что энерго-зависимая память является
  \emph{вр\'еменной}.  Примером энергозависимой памяти может служить оперативное
  запоминающее устройство (ОЗУ), данные в которой стираются после отключения
  питания.
\item \emph{Энерго-независимая} память сохраняет записанные в неё данные даже
  после отключения питания, что делает её \emph{перманентной} (или
  \emph{постоянной}) памятью.  Примером энергонезависимой памяти является
  твердотельнй накопитель (solid-state drive, или сокращённо ``SSD''), где
  данные сохраняются даже при отключении питания.  Здесь стоит заметить, что
  время хранения данных в SSD при отключенном питании не бесконечно, и
  составляет от 1 до 5 лет (для потребительских
  накопителей).\cite{storedbits:ssd-data-retention}
\end{itemize}

Информация в памяти хранится в виде бит, которые как правило сгруппированы в
байты (в большинстве современных компьютеров 1 байт содержит 8 бит.)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Иерархия памяти}
\index{Аппаратное обеспечение!Память!Иерархия памяти}

Память в компьютере можно представить иерархически, в соответствии с её объёмом
и временем доступа к данным.  На рис. \ref{fig:memory-hierarchy} можно видеть
визуализацию иерархии памяти в виде пирамиды, где при движении к вершине
пирамиды стоимость и скорость доступа увеличиваться, а объём памяти
уменьшается.\cite{branden-ghena:memory-hierarchy}

\figureMemoryHierarchy{ru}

Самой быстрой энергозависимой памятью (на верхушке нашей пирамиды) являются
\emph{регистры процессора}.  Количество и объём данных ячеек сильно ограничены и
зависит от устройства (архитектуры) процессора.  Доступ к регистровой памяти
осуществляется за один такт процессора.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Архитектура памяти}
\index{Аппаратное обеспечение!Память!Архитектура памяти}

Существуют две основных архитектуры памяти компьютера:
\begin{itemize}
\item \emph{Архитектура фон Неймана} -- названа в честь физика и информатика
  Джона фон Неймана (англ. \textit{John von Neumann}.)  В данной архитектуре
  программные инструкции и данные сохраняются в единой памяти.
\item \emph{Гарвардская архитектура} -- названа в честь компьютера \emph{Mark I},
  созданного в Гарварде.  Главное отличие данной архитектуры заключается в том,
  что она использует два независимых модуля памяти: один предназначен для
  хранения программных инструкций, а другой -- для хранения данных.  В данной
  архитектуре центральный процессор (ЦП) получает доступ к каждому виду памяти
  через различные шины связи.
\end{itemize}

Существуют также гибридные архитектуры, которые берут ``лучшее из двух миров'',
для повышения производительности.

На микроконтроллерах обычно используется Гарвардская архитектура, так как это
позволяет более эффективно выполнять задачи в условиях жёстких ограничений по
ресурсам.

Многие виды Arduino, которые могут вам встретиться, используют именно
Гарвардскую архитектуру -- а именно те, которые основаны микроконтроллерах
семейства AVR.  Например, сюда можно отнести микроконтроллер ATmega2560, лежащий
в основе Arduino Mega 2560 Rev3.\cite{arduino:memory-guide}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Карта памяти микроконтроллеров семейства AVR}
\index{Аппаратное обеспечение!Память!Карта памяти}

\newglossaryentry{EEPROM}{name=EEPROM, description={Electrically erasable
    programmable read-only memory}}

\newglossaryentry{RAM}{name=RAM, description={Random access memory}}

\newglossaryentry{ОЗУ}{name=ОЗУ, description={Оперативное запоминающее
    устройство -- см. также \gls{RAM}}}

\figureAVRMemory{ru}

Как мы говорили ранее, выделение памяти различается в разных архитектурах.  На
микроконтроллерах семейства AVR размещение памяти выглядит так, как показано на
рис. \ref{fig:avr-memory} (за основу схемы взята информация из
\cite{arduino:memory-guide} и \cite{avr:atmega328p-datasheet}.)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Программная память}

В левой части рисунка показана энергонезависимая программная память
(\emph{program memory}.)  В этой памяти располагается записанная в
микроконтроллер программа, также небольшая часть памяти отведена под специальную
программу, называемую \emph{загрузчиком} -- она как раз позволяет программировать
Arduino через обычное USB-подключение.

В центральной части рисунка можно видеть энергозависимую оперативную память
(\gls{ОЗУ}, или по-английски \gls{RAM}), называемую также \emph{памятью данных}
(англ. ``data memory''.)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{EEPROM}
\index{Архитектура процессора!Память!EEPROM}

В правой части рисунка находится ещё один вид энергонезависимой памяти,
называемый \gls{EEPROM}.  В отличии от памяти для программ, которую работающая
программа не может перезаписать, память EEPROM может быть перезаписана
динамически.  Этот вид памяти обычно используется для хранения данных, которые
должны сохранятся между перезапуском системы -- например, настроек.

Про работу с EEPROM мы будем говорить отдельно.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Регистры общего назначения}

Адреса \gls{RAM} с 0 (\mintinline{cpp}{0x0000}) по 31 (\mintinline{cpp}{0x001F})
на самом деле не являются частью физической памяти, а вместо этого представляют
собой отображение 32-х регистров процессора общего назначения (``general purpose
registers''.)

Регистрами называется свехбыстрая оперативная память внутри процессора, которая
используется для его работы.
\tableGPWR{ru}

В таблице \ref{table:avr-gpwr} показаны регистры общего назначения
микроконтроллеров AVR и их расположение в памяти.  Каждый регистр занимает 1
байт (8 бит), но при этом есть совмещённые регистры, которые могут
использоваться, как одна ячейка на 2 байта (16 бит) -- такими являются регистры
``X'', ``Y'' и ``Z''.

Регистры ``R0'' и ``R1'' имеют особое значение (см \cite{avr:gcc}, , ``Register
Layout''):
\begin{itemize}
\item ``R0'' используется, как временный регистр.
\item ``R1'' всегда содержит ноль.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Регистры ввода-вывода}

Далее, как показано на \ref{fig:avr-memory}, с адреса 32
(\mintinline{cpp}{0x0020}) по 95 (\mintinline{cpp}{0x005F}) следуют \emph{64
регистра ввода-вывода} (``64 I/O registers''), которые также являются
отображением специализированной памяти процессора.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Дополнительные регистры ввода-вывода}

После этого идут дополнительные регистры ввода-вывода (``Additional I/O
registers''.)  В микроконтроллере ``ATmega2560'' таких регистров 416
штук.\cite[22]{avr:atmega2560-datasheet}

\end{document}
