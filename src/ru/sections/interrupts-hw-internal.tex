\documentclass[../sparc.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Внутренние аппаратные прерывания}

Как говорилось ранее, источником внутренних прерываний являются периферийными
цепями внутри микроконтроллера.  Мы будем рассматривать подобные прерывания на
примере работы с \emph{таймерами}.

Таймер можно представить, как некоторый ``будильник'', который можно завести
внутри процессора и по его ``звонку'' вызывать некую процедуру -- обработчик
прерывания.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Принцип работы таймера}

Аппаратный таймер по принципу работы представляет собой счётчик.  Преимуществом
таймера является то, что изменение счётчика происходит по аппаратному тактовому
импульсу, не зависящиму от выполнения программы на микроконтроллере.  Это даёт
определённость (или, как говорят, \emph{детерминизм}) в его работе, что в свою
очередь позволяет с большой точностью отмерять промежутки времени, при условии
учёта частоты процессора.

Микроконтроллеры семейства AVR, на которых основана платформа Arduino, обычно
имеют два 8-битных таймера и один 16-битный.  Восьмибитный таймер может считать
от 0 до 255 ($2^{8}-1$), тогда как 16-битный таймер имеет диапазон от 0 до 65535
($2^{16}-1$.)  Таймер с разрешением в 16 бит является более гибким в
использовании, чем 8-битный, однако не всегда возникает необходимость в таком
большом разрешении.  К тому же, использование 8-битного таймера может дать более
эффективный и компактный код.\cite{avr:timers}

Микроконтроллер может быть настроен на отслеживание событий таймера (которых
существует несколько типов), чтобы по их приходу вызывать обработчик события.

Можно выделить три основных типа событий:
\begin{itemize}
\item Переполнение таймера (англ. ``Timer Overflow'')
\item Совпадение по сравнению (англ. ``Compare Match'')
\item Захват входного сигнала (англ. ``Input Capture'')
\end{itemize}

На данный момент нам наиболее важны первые два варианта, которые мы рассмотрим
сейчас подробнее.

\figureInterruptTimerOverflow{ru}

\emph{Переполнение таймера} возникает, когда счётчик таймера доходит до своего
максимального значения.  После этого происходит вызов обработчика прерывания
(если он назначен), потом -- сброс счётчика в ноль и отсчёт начинается заново.
Максимальное значение для таймера определяется его \emph{разрешением}.
Например, для восмибитного таймера максимальное значение будет 255:

\begin{equation}
  maximum\_value = 2^{timer\_resolution} - 1
\end{equation}

На рис. \ref{fig:timer-overflow-interrupt} схематически показана работа таймера
и красными точками отмечены моменты переполнения счётчика -- то есть, моменты
срабатывания прерывания по переполнению.

\emph{Совпадение по сравнению} возникает, когда значение счётчика таймера
достигает до заранее заданной отметки в допустимом диапазоне таймера (про
который мы говориле выше.)  Например, если мы выставим отметку на уровне 127, то
восмибитный таймер сработает на середине пути от нуля до переполнения.

\end{document}
