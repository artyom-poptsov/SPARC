\documentclass[../sparc.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Управление портами ввода-вывода}

В разделе \ref{section:avr-memory} мы рассмотрели устройство памяти
микроконтроллеров AVR.  Как было показано, внутренние регистры микроконтроллера
доступны, как часть адресного пространства памяти; таким образом, мы можем
менять различные параметры просто через записывание значений по определённым
адресам.

В данном разделе мы попробуем управлять светодидами напрямую через регистры
процессора.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Порты ввода-вывода}
\label{subsection:io-ports}

На микроконтроллерах AVR порты ввода-вывода объединены в группы по 8 штук,
называемые латинскими буквами.  Эти группы есть ни что иное, как восмибитные
регистры процессора, где каждый из 8 бит отвечает за отдельный цифровой порт
ввода-вывода.

В ATmega2560 эти регистры представлены\cite[96-100]{avr:atmega2560-datasheet}
следующими группами: ``A'', ``B'', ``C'', ``D'', ``E'', ``F'', ``G'', ``H'',
``J'', ``K'', ``L''.

Важно учитывать, что порядок расположения цифровых портов на платах Arduino не
соответствует их группировке в регистрах микроконтроллера.

Например, если мы сравним цифровые порты с 0 по 7 на плате Arduino Mega 2560 с
их расположением в регистрах, то увидим следующую картину:

\tableMCUPortsExample{ru}

Как видно, например, из таблицы \ref{table:mcu-io-registers-example}, порты
``D0'', ``D1'' ``D2'', ``D3'' и ``D5'' относятся к регистру ``E''.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{DDR: Data Direction Register}

Один из регистров процессора, который представляет для нас сейчас прямой интерес
-- это так называемый ``Регистр направления данных'' (Data Direction Register),
или же сокращённо ``DDR''.

Каждый раз, когда мы используем процедуру \mintinline{cpp}{pinMode}, мы на самом
деле меням значения в ``DDR''.

Существует несколько регистров ``DDR'', под каждую группу портов -- их имена
имеют вид ``DDRn'', где ``n'' -- это название группы портов ввода-вывода, которые
мы обсуждали в подразделе \ref{subsection:io-ports}: ``DDRA'', ``DDRB'' и т.п.

Если не использовать \mintinline{cpp}{pinMode}, то для того, чтобы настроить
цифровой порт 2 на режим вывода, нам потребуется написать следующий код:

\begin{listing}[H]
  \begin{minted}{cpp}
    void setup() {
      DDRE = DDRE | (1 << 4);
    }

    void loop() {

    }
  \end{minted}
  \caption{Пример настройки цифрового порта 2 на режим вывода через регистр
    процессора.}
  \label{listing:mcu-ddr-example}
\end{listing}

В листинге \ref{listing:mcu-ddr-example}, используя побитовый ``ИЛИ'' вместе с
побитовым сдвигом влево, мы выставляем 4-й бит в регистре ``DDRE'' в 1, таким
образом устанавливая режим вывода на цифровом порту номер 2 на Arduino.

Переменная \mintinline{cpp}{DDRE} хранит в себе адрес памяти, соответствующей
регистру ``DDRE'' -- таким образом, когда мы пишем в эту переменную значение, по
факту мы пишем его в регистр, на который она ссылается.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{PORT: Data Register}

Для управления значением на выходе цифрового порта нам доступны регистры
``PORTn'', где ``n'' -- это название группы портов, как и в случае с регистрами
``DDR''.  Например, управление значениями на портах в регистре ``E''
осуществляется через регистр ``PORTE''.

Обычно управление значением на выходе цифрового порта осуществляется через
процедуру \mintinline{cpp}{digitalWrite}, но мы можем сделать тоже самое в обход
данной процедуры, напрямую через регистр процессора.

Например, чтобы сделать мигающий светодиод на втором цифровом порту на плате
Arduino Mega 2560, мы можем написать следующий код:

\begin{listing}[H]
  \begin{minted}{cpp}
    void setup() {
      DDRE = DDRE | (1 << 4);
    }

    void loop() {
      PORTE = PORTE | (1 << 4);
      delay(100);
      PORTE = PORTE ^ (1 << 4);
      delay(100);
    }
  \end{minted}
  \caption{Пример управления значением цифрового порта 2 на Arduino Mega 2560
    через регистр процессора.}
  \label{listing:mcu-port-example-1}
\end{listing}

Этот пример можно упростить, путём замены явного выставления бита в регистре
\mintinline{cpp}{PORTE} на инверсию данного бита через операцию исключающего
``ИЛИ'' (``XOR''.)  Также мы можем использовать сокращённые формы операций --
такие, как ``\textbar='' и ``\^{}=''.

\begin{listing}[H]
  \begin{minted}{cpp}
    void setup() {
      DDRE |= (1 << 4);
    }

    void loop() {
      PORTE ^= (1 << 4);
      delay(100);
    }
  \end{minted}
  \caption{Пример управления значением цифрового порта 2 на Arduino Mega 2560
    путём инверсии бита в регистре процессора.}
  \label{listing:mcu-port-example-2}
\end{listing}

В примере \ref{listing:mcu-port-example-2} мы каждые 100мс инвертируем пятый бит
в регистре \mintinline{cpp}{DDRE}, таким образом меняя значение на
соответствующем порту Arduino.

\end{document}
