\documentclass[../sparc.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Реализация управления}

Для управления игровым персонажем нам потребуется некоторое устройство ввода
информации в наш компьютер (микроконтроллер).  Мы сделаем своё ``устройство
ввода'', состоящее из нескольких кнопок, расположенных на макетной плате.

\subsection{Подключение кнопки}

Попробуем подключить кнопку к Arduino.  Кнопка по своей сути не более чем
замыкатель двух контактов.  Самым простым аналогом кнопки являются два
разъединённых провода (разомкнутая электрическая цепь), которые можно соединить
между собой, или опять разъединить.  Само собой, такой способ управления
устройством неудобен (и даже небезопасен, при больших напряжениях и токах в
электрической цепи), поэтому кнопки обычно представлены некими закрытыми
устройствами, которые имеют некий способ замыкать цепь без необходимости брать в
руки концы проводов.

Кнопки по принципу работы бывают разные.  Самый простой их вид -- \emph{тактовые
кнопки}.

``Тактовыми'' называются кнопки, которые не ``запоминают'' своё состояние, и
сразу же после нажатия возвращаются в исходное состояние (как правило,
разомкнутое.)

Другой вид кнопок, с которыми мы сталкиваемся в быту -- это те, которые
``запоминают'' своё состояние; такие кнопки обычно называются
``переключателями''.

На рис. \ref{fig:game-dev-button-00} можно видеть один из возможных вариантов
подключения кнопки.  Можно подумать, что такой вариант достаточен -- когда
кнопка нажата, то цепь замыкатся и ток идёт от \texttt{5V} до цифрового порта
номер 2.  И действительно, в этом случае с порта можно считать значение 1
(\texttt{HIGH}).

\begin{figure}[ht]
  \centering
  \begin{circuitikz}
    \draw (3.5, 0) node[
      dipchip,
      num pins=2,
      external pins width=0.0,
      no topmark,
      hide numbers,
      xscale = 2.5,
      yscale = 2.5](C1){Arduino};
    \node [above left, font=\small] at (C1.bpin 1) {5V};
    \node [above right, font=\small] at (C1.bpin 2) {2};
    \draw
    (C1.bpin 1) to[short]
    (0, 0) to[short]
    (0, 4) to[push button, l=Тактовая кнопка] (7, 4)
    (7, 4) to[short]
    (7, 0) to[short]
    (C1.bpin 2);
  \end{circuitikz}
  \caption{Возможная схема подключения кнопки к Arduino.}
  \label{fig:game-dev-button-00}
\end{figure}

Пример простейшей программы, считывающей значение с кнопки, представлен ниже.

\begin{minted}{cpp}
  void setup() {
    pinMode(2, INPUT);
  }

  void loop() {
    // Считываем значение с кнопки и сохраняем в новую переменную "value".
    int value = digitalRead(2);
    // Далее эту переменную можно использовать в коде, чтобы определить
    // состояние кнопки: если в переменной находится значение 1,
    // то кнопка нажата, если 0 -- то не нажата.
  }
\end{minted}

Чтобы наглядно получить представление о том, как значение на кнопке будет
меняться при нажатии, мы можем дабавить вывод данных на компьютер.

\begin{minted}{cpp}
  void setup() {
    pinMode(2, INPUT);
    Serial.begin(9600);
  }

  void loop() {
    // Считываем значение с кнопки и сохраняем в новую переменную "value".
    int value = digitalRead(2);
    // Далее эту переменную можно использовать в коде, чтобы определить
    // состояние кнопки: если в переменной находится значение 1,
    // то кнопка нажата, если 0 -- то не нажата.

    // Выводим значение с кнопки в порт.
    Serial.println(value);
  }
\end{minted}

К сожалению, наблюдение за значенем на кнопке скорее всего нам покажет, что даже
когда кнопка не нажата, на ней иногда ``проскакивает'' значение 1.  Как такое
может быть?  Объяснение простое -- как мы видели в главе ``Белый шум'', вокруг
нас присутствует электромагнитный фон, который улавливается схемами и приводит к
тому, что иногда значение на цифровых портах переходит рубеж, после которого
Arduino считает это значение единицей.

Решить эту проблему можно как минимум двумя способами.  Первый способ
заключается в том, чтобы поставить специальный \emph{подтягивающий резистор},
который будет подтягивать значение на порту, куда подключена кнопка, к земле
(GND.)

\begin{figure}[ht]
  \centering
  \begin{circuitikz}
    \draw (3.5, 0) node[
      dipchip,
      num pins=3,
      external pins width=0.0,
      no topmark,
      hide numbers,
      xscale = 2.5,
      yscale = 2.5](C1){Arduino};
    \node [above left, font=\small] at (C1.bpin 1) {5V};
    \node [above right, font=\small] at (C1.bpin 2) {2};
    \node [above right, font=\small] at (C1.bpin 3) {GND};
    \draw
    (C1.bpin 1) to[short]
    (0, 0.35) to[short]
    (0, 4) to[push button, l=Тактовая кнопка] (9, 4)
    (9, 4) to[short]
    (9, -0.35) to[short]
    (C1.bpin 2);
    \draw
    (C1.bpin 3) to [short]
    (7, 1) to [resistor, l=$R_1$]
    (8, 1) to [short]
    (9, 1);
    
  \end{circuitikz}
  \caption{Схема подключения кнопки к Arduino с подтягивающим резистором.}
  \label{fig:game-dev-button-with-pull-down-resistor}
\end{figure}

\subsection{Обработка нажатий}

Самым простым для нас способом обработки нажатий является поочерёдный опрос
кнопок.

\end{document}
