\documentclass[../sparc.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Музыкальный размер}
\index{Музыка!Музыкальный размер}

Вы могли видеть, что на нотном стане в самом начале, возле скрипичного (или
басового) ключа часто написано $\frac{4}{4}$ -- что же это означает?

Пометка $\frac{4}{4}$ (читается как ``четыре четверти'') обозначает
\emph{музыкальный размер} произведения.  С точки зрения кодирования мелодии в
программе это не влияет ни на частоту нот, ни на их длительность.  При этом,
однако, данная пометка напрямую влияет на звучание произведения, и без её учёта
все произведения будут звучать ``плоско'' и менее интересно.

Удивительный эффект музыкальный размер даёт благодаря \emph{акцентированию}
определённых нот.

Например, посмотрим ещё раз на ``Twinkle, Twinkle, Little Star''
(\ref{fig:lilypond-musical-scale-example-1}.)

\begin{figure}[ht]
  \centering
  \begin{lilypond}
    \relative c' {
      \numericTimeSignature
      \time 4/4
      c4 c g' g
      a a g2
      f4 f e e
      d d c2
      g'4 g f f
      e e d2
      g4 g f f
      e e d2
      c4 c g' g
      a a g2
      f4 f e e
      d d c2
    }
    \layout {
      indent = 0\mm
      line-width = 100\mm
      ragged-last = ##t
    }
  \end{lilypond}
  \caption{``Twinkle, Twinkle, Little Star'' в размере четыре четверти.}
  \label{fig:lilypond-musical-scale-example-1}
\end{figure}

Поскольку композиция записана в музыкальном размере ``четыре четверти'', то в
один такт убирается ровно четыре четвёртных ноты, или суммарно единица (или одна
целая нота.)  Числитель данной дроби указывает, сколько частей -- или, по-другому
называемые \emph{долей} -- убирается в такт.  Знаменатель дроби указывает, на
какие именно доли делится такт.  В размере ``четыре четверти'' такт делится на
четыре части по одной четвертной ноте.

При игре музыкального произведения на каком-либо инструменте акцент идёт обычно
на первую ноту из такта -- на её \emph{сильную долю}.  Доли, которые не
акцентированы, называются \emph{слабыми долями}.

С точки зрения исполнения акцентированные ноты должны звучать громче, или
каким-либо другим способом выделяться в общем звучании.

Акцент нот обозначается значком ``>'' над (или под) нотой.  Если мы расставим
значки, обозначающие акцент, то получим следующую запись
(см. рис. \ref{fig:lilypond-musical-scale-example-2}.)

\begin{figure}[ht]
  \centering
  \begin{lilypond}
    \relative c' {
      \numericTimeSignature
      \time 4/4
      c4-> c g'-> g
      a-> a g2->
      f4-> f e->  e
      d-> d c2->
      g'4-> g f-> f
      e-> e d2->
      g4-> g f-> f
      e-> e d2->
      c4-> c g'-> g
      a-> a g2->
      f4-> f e-> e
      d-> d c2->
    }
    \layout {
      indent = 0\mm
      line-width = 100\mm
      ragged-last = ##t
    }
  \end{lilypond}
  \caption{``Twinkle, Twinkle, Little Star'' с указанием акцентов (знак ``>''
    под нотами.)}
  \label{fig:lilypond-musical-scale-example-2}
\end{figure}

Музыкальный размер ``четыре четверти'' называется \emph{сложным}, так как он
получен слиянием двух более \emph{простых} размеров, а именно ``две четверти''.

Таким образом, в размере ``четыре четверти'' кроме сильной доли, появляется
вторая доля, называемая \emph{относительно сильной}.

Как можно видеть на рис. \ref{fig:lilypond-musical-scale-example-2}, первый
(основной) акцент ставится на первую ноту в такте -- в нашем случае, первую
четверть.  Второй (второстепенный) акцент ставится на третью ноту в такте -- или
же, можно сказать, на первую ноту второй половины такта (относительно сильную
долю.)  Основной акцент, по определению, более выраженный, чем второстепенный.

Если мы возьмём другой музыкальный размер -- например, две четверти
($\frac{2}{4}$), то произведение будет звучать по-другому, поскольку основной и
единственный акцент будет на первую ноту каждого такта, и относительно слабая
доля будет отстуствовать.

\begin{figure}[ht]
  \centering
  \begin{lilypond}
    \relative c' {
      \numericTimeSignature
      \time 2/4
      c4-> c
      g'-> g
      a-> a
      g2->
      f4-> f e->  e
      d-> d c2->
      g'4-> g f-> f
      e-> e d2->
      g4-> g f-> f
      e-> e d2->
      c4-> c g'-> g
      a-> a g2->
      f4-> f e-> e
      d-> d c2->
    }
    \layout {
      indent = 0\mm
      line-width = 100\mm
      ragged-last = ##t
    }
  \end{lilypond}
  \caption{``Twinkle, Twinkle, Little Star'' в размере две четверти.}
  \label{fig:lilypond-musical-scale-example-3}
\end{figure}

Музыкальный размер ``две четверти'' используется в таких стилях музыки, как,
например, полька.

Если мы возьмём музыкальный размер ``три четверти''
(см. рис. \ref{fig:lilypond-musical-scale-example-4}), в такт будет убираться
ровно три четвертных ноты.  Таким образом, акцент будет идти на первую четверть
из трёх в каждом такте.  При этом, некоторые ноты длиной $\frac{1}{2}$ как бы
``разрезаются'' тактовой чертой на две четверти.

\begin{figure}[h]
  \centering
  \begin{lilypond}
    \relative c' {
      \numericTimeSignature
      \time 3/4
      c4->  c g'
      g->   a a
      g2->  f4
      f->   e e
      d->   d c4~4->
      g'4   g
      f->   f e
      e->   d2
      g4->  g f
      f->   e e
      d2    c4
      c->   g' g
      a->   a g4~4->
      f4    f
      e->   e d
      d->   c2
    }
    \layout {
      indent = 0\mm
      line-width = 100\mm
      ragged-last = ##t
    }
  \end{lilypond}
  \caption{``Twinkle, Twinkle, Little Star'' в размере три четверти}
  \label{fig:lilypond-musical-scale-example-4}
\end{figure}

Такая запись в отношении ``Twinkle, Twinkle, Little Star'' выглядит
противоестественно, и после таких экспериментов к вам в дверь может постучатся
музыкальная инквизиция.

Тем не менее, если мы сыграем в таком размере композицию музыкальном
инструменте, то она будет звучать вальсирующе, ведь музыкальный размер ``две
четверти'' обычно используется для вальса.

Каким же образом мы можем выразить эти музыкальные нюансы в нашем программном
коде и в реализации аппаратной части, чтобы они украсили наше музыкальное
произведение?  Изменение кода включает в себя несколько этапов.

Во-первых, самым простым для нас способом выделить какие-то определённые ноты
является подключение дополнительного динамика с меньшей громкостью к Arduino.
Ноты, которые должны звучать тише, будут отправляться на него.  А те ноты,
которые должны быть акценированными, будут отправлятсья на громкий динамик.
Допустим, громкий динамик будет у нас на цифровом порту 2, а тихий динамик -- на
цифровом порту 3.

\begin{listing}[ht]
  \begin{minted}{cpp}
    const int LOUD_SPEAKER_PIN  = 2; // Громкий динамик.
    const int QUIET_SPEAKER_PIN = 3; // Тихий динамик.

    // ...

    void setup() {
      pinMode(LOUD_SPEAKER_PIN, OUTPUT);
      pinMode(QUIET_SPEAKER_PIN, OUTPUT);
    }
  \end{minted}
  \label{listing:adding-additional-speaker}
  \caption{Добавление второго динамика для воспроизведения нот с разным уровнем
    громкости.}
\end{listing}

Во-вторых, двумерный массив нот должен теперь иметь не два столбца, а три, так
как в третьем столбце мы как раз будем хранить громкость ноты.  Исходя из
параметра громкости, который на данный момент может иметь всего два уровня -- 0
(тихо) и 1 (громко), мы будем выбирать динамик для воспроизведения ноты.

Для размера ``четыре четверти'' мы будем первую ноту из такта делать громче
остальных.

\begin{listing}[!h]
  \begin{minted}{cpp}
    // ...

    float twinkle_twinkle_little_star[][3] = {
      {c4, 4, 1}, {c4, 4, 0}, {g4, 4, 0}, {g4, 4, 0},  // 0
      {a4, 4, 1}, {a4, 4, 0}, {g4, 4, 0},              // 1
      {f4, 4, 1}, {f4, 4, 0}, {e4, 4, 0}, {e4, 4, 0},  // 2
      {d4, 4, 1}, {d4, 4, 0}, {c4, 4, 0},              // 3

      {g4, 4, 1}, {g4, 4, 0}, {f4, 4, 0}, {f4, 4, 0},  // 4
      {e4, 4, 1}, {e4, 4, 0}, {d4, 4, 0},              // 5
      {g4, 4, 1}, {g4, 4, 0}, {f4, 4, 0}, {f4, 4, 0},  // 6
      {e4, 4, 1}, {e4, 4, 0}, {d4, 4, 0},              // 7

      {c4, 4, 1}, {c4, 4, 0}, {g4, 4, 0}, {g4, 4, 0},  // 8
      {a4, 4, 1}, {a4, 4, 0}, {g4, 4, 0},              // 9
      {f4, 4, 1}, {f4, 4, 0}, {e4, 4, 0}, {e4, 4, 0},  // 10
      {d4, 4, 1}, {d4, 4, 0}, {c4, 4, 0},              // 11
    };

    // ...
  \end{minted}
  \label{listing:adding-musical-scale-to-array}
  \caption{Добавление акцента к нотам ноту согласно музыкальному
    размеру.}
\end{listing}

Далее при воспроизведении музыки нам надо выбирать нужный динамик, в
соответствии с громкостью (акцентом) ноты.

\begin{listing}[h]
  \begin{minted}{cpp}
    // ...

    void loop() {
      const long BPM = 120;
      const long MINUTE = 60 * 1000000;
      const long T = (MINUTE / BPM) * 4;

      for (int note_idx = 0; note_idx < 28; note_idx++) {
        if (melody[note_idx][2] == 1) {
          // Нота с акцентом
          play_tone(LOUD_SPEAKER_PIN,
          melody[note_idx][0],
          T / melody[note_idx][1]);
        } else {
          // Нота без акцента
          play_tone(QUIET_SPEAKER_PIN,
          melody[note_idx][0],
          T / melody[note_idx][1]);
        }
        delay(100);
      }
    }
  \end{minted}
  \label{listing:musical-scale-implementation}
  \caption{Реализация акцента на определённую ноту согласно музыкальному
    размеру.}
\end{listing}

В примере \ref{listing:musical-scale-implementation} мы в тело цикла добавили
проверку, что если в текущей взятой из массива строке во второй ячейке считая с
нуля находится единица, это значит, что данная нота находится под акцентом и
должна быть сыграна громче остальных.  Подобные ноты мы отправляем на динамик,
подключенный к \texttt{LOUD\_SPEAKER\_PIN}.  Остальные ноты, как описано в блоке
\texttt{else}, отправляются на динамик, подключенный к порту
\texttt{QUIET\_SPEAKER\_PIN}.

\end{document}
